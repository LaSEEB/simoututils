## Analysis of simulation output

### File format

TSV file (tab-separated values), one column per output, one row per iteration, 
as shown in the following example, which shows the first 10 lines of a 
simulation output file generated by a PPHPC implementation: 

```
6400	3200	80075	4.509375	20.6634375	2.74455625
5696	3244	85138	5.953476123595506	20.11189889025894	2.433275
5455	3331	90629	6.927956003666361	19.165115580906633	2.123325
5337	3418	96563	7.538504777965149	18.065535400819194	1.81894375
5247	3461	102366	8.146178768820278	17.246460560531638	1.55265
5226	3477	108222	8.66934557979334	16.597354040839804	1.325125
5191	3486	114093	9.277017915623194	15.99885255306942	1.1388875
5206	3500	119900	9.827314636957357	15.338857142857142	0.99003125
5212	3515	125627	10.427091327705295	14.636130867709815	0.88034375
5241	3465	131158	10.964892196145774	14.225396825396825	0.807075
```

For the PPHPC model, the six columns in the example represent the following
outputs: 

1. Sheep population
2. Wolves population
3. Quantity of available grass
4. Mean sheep energy
5. Mean wolves energy
6. Mean value of the countdown parameter in all cells.

### Utilities

* [dist_plot_per_fm](dist_plot_per_fm.m) - Plot the distributional properties of 
one focal measure (i.e. of a statistical summary of a single output), namely its
probability density function (estimated), histogram and QQ-plot.

* [dist_table_per_fm](dist_table_per_fm.m) - Outputs a LaTeX table with a 
distributional analysis of a focal measure for a number of 
setups/configurations. For each setup/configuration, the table shows the 
_p_-value of the Shapiro-Wilk test, skewness, histogram and QQ-plot.

* [dist_table_per_setup](dist_table_per_setup.m) - Outputs a LaTeX table with a
distributional analysis of all focal measures for one model setup/configuration.
For each focal measure, the table shows the mean, variance, p-value of the 
Shapiro-Wilk test, skewness, histogram and QQ-plot.

* [output_plot](output_plot.m) - Plot time-series simulation output from one or 
more replications using one of three approaches: superimposed, extremes or
moving average.

* [stats_analyze](stats_analyze.m) - Analyze statistical summaries taken from 
simulation output.

* [stats_gather](stats_gather.m) - Get statistical summaries taken from 
simulation outputs from multiple files. The exact statistical summaries depend 
on how the [stats_get](stats_get.m) function is configured.

* [stats_get](stats_get.m) - This is a facade function for `stats_get_*` 
functions. These functions extract statistical summaries from simulation outputs 
from one file. The exact `stats_get_*` function to use is specified in the first
line of this function. Two `stats_get_*` functions are included in this package:
  * [stats_get_pphpc](stats_get_pphpc.m) - Obtain the **max**, **argmax**,
    **min**, **argmin**, **mean** and **std** statistical summaries from 
    simulation outputs given in a file (package default).
  * [stats_get_iters](stats_get_iters.m) - Obtain statistical summaries 
    corresponding to output values at user-specified iterations from simulation
    outputs given in a file.

* [stats_table_per_setup](stats_table_per_setup.m) - Outputs a plain text or 
LaTeX table with the statistics returned by the [stats_analyze](stats_analyze.m) 
function for all focal measures for one model setup/configuration.

### Examples

These examples use the datasets available at 
[![DOI](https://zenodo.org/badge/doi/10.5281/zenodo.34053.svg)](http://dx.doi.org/10.5281/zenodo.34053).
Unpack the datasets to any folder and put the complete path to this 
folder in variable `datafolder`, e.g.:

```matlab
datafolder = 'path/to/datasets';
```

These datasets correspond to the results presented in the article
[Towards a standard model for research in agent-based modeling and simulation](https://peerj.com/articles/cs-36/).

#### Example 1: Plot simulation output

Use the [output_plot](output_plot.m) to plot outputs from one replication of the
PPHPC model:

```matlab
output_plot([datafolder '/v1'], 'stats100v1r1.txt');
```

![simout_ex01_01](https://cloud.githubusercontent.com/assets/3018963/11877081/0209605a-a4e5-11e5-8092-95dfe0bbcd5b.png)

Outputs 4 to 6 are practically not visible, as they have a very different scale
from outputs 1 to 3. Also, the legend does not show personalized output names.
Both problems can be solved by invoking [output_plot](output_plot.m) in the
following way:

```matlab
outputs = {'SheepPop', 'WolfPop', 'GrassQty', 'SheepEnergy', 'WolfEnergy', 'GrassEnergy'};
output_plot([datafolder '/v1'], 'stats100v1r1.txt', outputs, 'a', [3 3]);
```

![simout_ex01_02](https://cloud.githubusercontent.com/assets/3018963/11877082/02217ffa-a4e5-11e5-9729-ed5678443c96.png)
![simout_ex01_03](https://cloud.githubusercontent.com/assets/3018963/11877083/0230e2a6-a4e5-11e5-884f-fc6140e258af.png)

Here we specify proper output names in the 3rd parameter, the type of plot in
the 4th parameter (i.e. plot **a**ll available replications), and the layout
of the figures in the 5th parameter (i.e. plot 3 outputs in one figure, and
the remaining 3 in another figure). Much better now. However, the 3rd and 6th 
outputs (GrassQty and GrassEnergy, respectively) are still somewhat out of scale
with the remaining outputs. This can be solved by passing a scale vector as the 
6th parameter:

```matlab
outputs = {'SheepPop', 'WolfPop', 'GrassQty/4', 'SheepEnergy', 'WolfEnergy', '4*GrassEnergy'};
output_plot([datafolder '/v1'], 'stats100v1r1.txt', outputs, 'a', [3 3], [1 1 1/4 1 1 4]);
```

![simout_ex01_04](https://cloud.githubusercontent.com/assets/3018963/11877084/02356862-a4e5-11e5-8c79-06a85fda0a67.png)
![simout_ex01_05](https://cloud.githubusercontent.com/assets/3018963/11877085/023607ea-a4e5-11e5-83e2-8807d9927253.png)

The plot looks good now. In order to plot outputs from multiple replications, we
simply use wildcards to load more than one file:

```matlab
output_plot([datafolder '/v1'], 'stats100v1r*.txt', outputs, 'a', [3 3], [1 1 1/4 1 1 4]);
```

![simout_ex01_06](https://cloud.githubusercontent.com/assets/3018963/11877088/023508a4-a4e5-11e5-91d0-1cc2274a3537.png)
![simout_ex01_07](https://cloud.githubusercontent.com/assets/3018963/11877086/02362194-a4e5-11e5-889d-95f82bd69fac.png)

When plotting multiple replications in this way, the figures tend to look
somewhat heavy and slow to manipulate. We could alternatively plot only the
output extremes (minimum and maximum of individual outputs at each iteration),
and fill the space between with the output color. This can be accomplished by 
specifying type **f**ill as the 4th parameter:

```matlab
output_plot([datafolder '/v1'], 'stats100v1r*.txt', outputs, 'f', [3 3], [1 1 1/4 1 1 4]);
```

![simout_ex01_08](https://cloud.githubusercontent.com/assets/3018963/11877087/0238c8b8-a4e5-11e5-9663-bf792e8a289e.png)
![simout_ex01_09](https://cloud.githubusercontent.com/assets/3018963/11877089/0247e3b6-a4e5-11e5-9be5-aa0b073e185d.png)

Finally, it's also possible to visualize the moving average of each output over
multiple replications by passing a positive integer as the 4th parameter. This 
positive integer is the window size with which to smooth the output. A value of 
zero is equivalent to no smoothing, i.e. the function will simply plot the 
averaged outputs. A value of 10 offers a good balance between rough and overly 
smooth plots:

```matlab
output_plot([datafolder '/v1'], 'stats100v1r*.txt', outputs, 10, [3 3], [1 1 1/4 1 1 4]);
```

![simout_ex01_10](https://cloud.githubusercontent.com/assets/3018963/11877090/024d2362-a4e5-11e5-908f-533e5dca8d8a.png)
![simout_ex01_11](https://cloud.githubusercontent.com/assets/3018963/11877091/025138f8-a4e5-11e5-88fb-ffa524459581.png)

The moving average type of plot is useful for empirically selecting a 
steady-state truncation point.

#### Example 2: Get and analyze statistical summaries taken from simulation output

First, get statistical summaries for 30 runs of the PPHPC model for size
100 and parameter set 1, where 6 corresponds to the number of outputs of
the PPHPC model and 1000 to the iteration after which the outputs are in 
steady-state.

```matlab
s100v1 = stats_gather('100v1', [datafolder '/v1'], 'stats100v1r*.txt', 6, 1000);
```
Six statistical summaries are returned: maximum (**max**), iteration 
where maximum occurs (**argmax**), minimum (**min**), iteration 
where minimum occurs (**argmin**), mean (**mean**), and standard 
deviation (**std**). The **mean** and **std** statistics are obtained
during the steady-state phase of the output.

The [stats_gather](stats_gather.m) returns a _struct_ containing three 
fields: 1) `name` contains the name with which the data was tagged, 
'100v1' in this case; 2) cell array containing the output names (which
default to 'o1', 'o2', etc.); and, 3) `sdata`, a 30 x 36 matrix, with 30
observations (from 30 files) and 36 focal measures (six statistical 
summaries for each of the six outputs).

Instead of the number of outputs, the [stats_gather](stats_gather.m) 
alternatively accepts a cell array of strings containing the output 
names, which can be useful for latter producing publication quality
tables.

Let's now analyze the focal measures (i.e. statistical summaries for
each output). The 0.05 value in the second parameter is the significance
level for the confidence intervals and the Shapiro-Wilk test:

```matlab
[m, v, cit, ciw, sw, sk] = stats_analyze(s100v1.sdata', 0.05);
```

The variables returned by the [stats_analyze](stats_analyze.m) function
have 36 rows, one per focal measure. The `m` (mean), `v` (variance), 
`sw` (_p_-value of the Shapiro-Wilk test) and `sk` (skewness) variables
have only one column, i.e. one value per focal measure, while the `cit`
(_t_-confidence interval) and `ciw` (Willink confidence interval)
variables have two columns, which correspond to the lower and upper
limits of the respective intervals.

While the data returned by the [stats_analyze](stats_analyze.m) is in a 
format adequate for further processing and/or analysis, it is not very
human readable. To this purpose, one can use the [stats_table_per_setup](stats_table_per_setup.m) 
function to output a nice plain text table (the last parameter, 0, 
specifies plain text output):

```matlab
stats_table_per_setup(s100v1, 0.05, 0)
```

This function can also output a publication quality LaTeX table by 
setting the last argument to 1:

```matlab
stats_table_per_setup(s100v1, 0.05, 1)
```

The produced LaTeX table requires the [siunitx], [multirow], [booktabs] 
and [ulem] packages to compile.

#### Example 3: Visually analyze the distributional properties of a focal measure

The [dist_plot_per_fm](dist_plot_per_fm.m) function offers a simple way of
assessing the distributional properties of a focal measure for different
model configurations (i.e. different model sizes, different parameter
set, etc). It works with the data returned by the [stats_gather](stats_gather.m)
function. 

* For example, lets assess the distributional properties of the PPHPC
focal measure given by the **argmin** of the _grass quantity_ output for
parameter set 2 and a number of different model sizes:

```matlab
% Get statistical summaries for different model sizes, parameter set 2
outputs = {'SheepPop', 'WolfPop', 'GrassQty', 'SheepEn', 'WolfEn', 'GrassEn'};
s100v2 = stats_gather('100v2', [datafolder '/v2'], 'stats100v2r*.txt', outputs, 2000);
s200v2 = stats_gather('200v2', [datafolder '/v2'], 'stats200v2r*.txt', outputs, 2000);
s400v2 = stats_gather('400v2', [datafolder '/v2'], 'stats400v2r*.txt', outputs, 2000);
s800v2 = stats_gather('800v2', [datafolder '/v2'], 'stats800v2r*.txt', outputs, 2000);
s1600v2 = stats_gather('1600v2', [datafolder '/v2'], 'stats1600v2r*.txt', outputs, 2000);

% Group them into a cell array
sv2 = {s100v2, s200v2, s400v2, s800v2, s1600v2};

% Plot distributional properties
dist_plot_per_fm(sv2, 3, 4);
```

Note that in this example we explicitly specified the output names when
calling the [stats_gather](stats_gather.m) function. Also, for parameter
set 2, we set the steady-state truncation point to iteration 2000.

#### Example 4: LaTeX table with distributional analysis of all focal measures for one setup

In the article [Towards a standard model...](https://peerj.com/articles/cs-36/)
a number of [tables](https://doi.org/10.7717/peerj-cs.36/supp-2) 
containing a detailed distributional analysis of all PPHPC focal 
measures are provided as supplemental information. Each table displays a
distributional analysis for one setup, i.e. for one size/parameter set
combination. The [dist_table_per_setup](dist_table_per_setup.m) 
returns these tables, accepting a single parameter which corresponds to
the output of the [stats_gather](stats_gather.m) function. For example,
to get a table with the distributional analysis of all PPHPC focal
measures for model size 1600, parameter set 2, only two commands are
required:

```matlab
outputs = {'$P^s_i$', '$P^w_i$', '$P^c_i$', '$\bar{E}^s_i$', '$\bar{E}^w_i$', '$\bar{C}_i$'};
s1600v2 = stats_gather('1600v2', [datafolder '/v2'], 'stats1600v2r*.txt', outputs, 2000);
dist_table_per_setup(s1600v2)
```
We specify the output names in LaTeX math mode so they appear in the
produced table as they appear in the article.

#### Example 5: LaTeX table with a distributional analysis of one focal measure for multiple setups

A distributional analysis of a focal measure for multiple setups is often
useful for evaluating how its distributional properties vary with different
model configurations/setups. The [dist_table_per_fm](dist_table_per_fm.m)
function fits this purpose. However, this function returns a partial table, 
which can have additional columns (specified with the 'pre' parameter) prior to
the distributional data itself, as well as additional rows, such as headers, 
footers, similar partial tables for other focal measures, and so on.

Using the PPHPC model as an example, lets output a table with the distributional
analysis of the steady-state mean of the sheep population, for all tested model
sizes and both parameter sets. Model sizes are specified as columns, while
parameter sets are obtained with two separate partial tables, which together 
form the final table:

```matlab

% Get stats data for parameter set 1, all sizes
s100v1 = stats_gather('100v1', [datafolder '/v1'], 'stats100v1r*.txt', outputs, 1000);
s200v1 = stats_gather('200v1', [datafolder '/v1'], 'stats200v1r*.txt', outputs, 1000);
s400v1 = stats_gather('400v1', [datafolder '/v1'], 'stats400v1r*.txt', outputs, 1000);
s800v1 = stats_gather('800v1', [datafolder '/v1'], 'stats800v1r*.txt', outputs, 1000);
s1600v1 = stats_gather('1600v1', [datafolder '/v1'], 'stats1600v1r*.txt', outputs, 1000);
datas1 = {s100v1, s200v1, s400v1, s800v1, s1600v1};

% Get stats data for parameter set 2, all sizes
s100v2 = stats_gather('100v2', [datafolder '/v2'], 'stats100v2r*.txt', outputs, 2000);
s200v2 = stats_gather('200v2', [datafolder '/v2'], 'stats200v2r*.txt', outputs, 2000);
s400v2 = stats_gather('400v2', [datafolder '/v2'], 'stats400v2r*.txt', outputs, 2000);
s800v2 = stats_gather('800v2', [datafolder '/v2'], 'stats800v2r*.txt', outputs, 2000);
s1600v2 = stats_gather('1600v2', [datafolder '/v2'], 'stats1600v2r*.txt', outputs, 2000);
datas2 = {s100v2, s200v2, s400v2, s800v2, s1600v2};

% Specify the focal measure: steady-state mean of the sheep population
out = 1;   % Sheep population
ssumm = 5; % Steady-state mean

% Table headers
t = sprintf('\n\\begin{table}[ht]');
t = sprintf('%s\n\\centering', t);
t = sprintf('%s\\begin{tabular}{ccrrrrrr}\n', t);
t = sprintf('%s\\toprule\n', t);
t = sprintf('%sSet & Stat. & 100 & 200 & 400 & 800 & 1600\\\\\n', t);
t = sprintf('%s\\midrule\n\\multirow{4}{*}{v1} ', t);

% First partial table, for parameter set 1
t = sprintf('%s%s', t, dist_table_per_fm(datas1, out, ssumm, 1));

% A midrule to separate the partial tables
t = sprintf('%s\\midrule\n\\multirow{4}{*}{v2}', t);

% Second partial table, for parameter set 2
t = sprintf('%s%s', t, dist_table_per_fm(datas2, out, ssumm, 1));

% Table footers and caption
t = sprintf('%s\\bottomrule\n', t);
t = sprintf('%s\n\\end{tabular}', t);
t = sprintf('%s\n\\caption{Distributional analysis of sheep population steady-state mean for different model sizes and parameter sets.}\n', t);
t = sprintf('%s\n\\end{table}\n', t);

% Show the table
t
```

[siunitx]: https://www.ctan.org/pkg/siunitx
[ulem]: https://www.ctan.org/pkg/ulem
[multirow]: https://www.ctan.org/pkg/multirow
[booktabs]: https://www.ctan.org/pkg/booktabs

